<app-admin-header></app-admin-header>
<div class="main-content">
    <div *ngIf="assignmentBanner.show" class="assignment-banner animate__animated animate__fadeInDown fixed-top bg-success text-white p-3 shadow-lg text-center" style="z-index: 1050;">
        <i class="bi bi-truck me-2"></i> Order #{{ assignmentBanner.orderID }} has been assigned to <strong>{{ assignmentBanner.agentName }}</strong>!
    </div>

    <div class="container mt-4 mb-5">
        <h3 class="fw-bold mb-4 text-center text-secondary">ðŸ“¦ Order Management Dashboard</h3>
        <ul class="nav nav-tabs order-tabs mb-4 justify-content-center" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link" [class.active]="activeTab === 'placed'" (click)="setActiveTab('placed')"> ðŸŸ Placed ({{ placedOrders.length }}) </button>
            </li>

            <li class="nav-item" role="presentation">
                <button class="nav-link" [class.active]="activeTab === 'assigned'" (click)="setActiveTab('assigned')"> ðŸ”µ Assigned ({{ assignedOrders.length }}) </button>
            </li>

            <li class="nav-item" role="presentation">
                <button class="nav-link" [class.active]="activeTab === 'delivered'" (click)="setActiveTab('delivered')"> ðŸŸ¢ Delivered ({{ deliveredOrders.length }}) </button>
            </li>
        </ul>

        <div class="tab-transition row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
            <ng-container *ngIf="getOrdersForTab(activeTab).length > 0; else noOrdersMessage">
                <div class="col" *ngFor="let order of getOrdersForTab(activeTab); ">
                    <div class="card order-card h-100 shadow-sm border-2" [ngClass]="activeTab === 'assigned' ? 'border-primary' : (activeTab === 'delivered' ? 'border-success' : 'border-warning')">
                        <div class="card-body p-4">
                            <div class="d-flex justify-content-between align-items-center mb-3 border-bottom pb-2">
                                <h5 class="card-title fw-bold text-primary mb-0">Order #{{ order.orderID }}</h5>
                                <span class="badge rounded-pill text-uppercase py-2 px-3" [ngClass]="'bg-' + getStatusColor(order.status)"> {{ order.status }} </span>
                            </div>

                            <div class="row g-2 mb-3">
                                <div class="col-6">
                                    <small class="text-muted d-block fw-semibold mb-1">Customer Details</small>
                                    <p class="mb-0 fw-bold">{{ order.customerName || 'N/A' }}</p>
                                    <small class="text-truncate d-block text-secondary">{{ order.dropAddress }}</small>
                                </div>

                                <div class="col-6 border-start ps-3">
                                    <small class="text-muted d-block fw-semibold mb-1">Restaurant Info</small>
                                    <p class="mb-0 fw-bold"> {{ order.restaurantName || 'Global Restaurant' }}</p>
                                    <small class="text-truncate d-block text-secondary">{{ order.pickupAddress || '123 Food Street' }}</small>
                                </div>
                            </div>

                            <h6 class="mt-3 mb-2 fw-semibold">ðŸ›’ Order Items ({{ order.items.length || 0 }}):</h6>
                            <ul class="list-unstyled small ps-3 order-items-list border-bottom pb-3">
                                <li *ngFor="let item of order.items" class="d-flex justify-content-between">
                                    <span>{{ item.name }}</span>
                                    <span>&times; <strong class="text-dark">{{ item.quantity }}</strong></span>
                                </li>
                            </ul>

                            <div class="text-end border-top pt-3 mt-3">
                                <h5 class="fw-bold mb-0"> Total: <span class="text-success">â‚¹{{ order.totalAmount | number:'1.2-2' }}</span> </h5>
                            </div>

                            <ng-container *ngIf="activeTab === 'placed'">
                                <div class="assignment-panel mt-3 p-3 bg-light rounded shadow-sm">
                                    <label class="form-label fw-bold small">Assign Agent:</label>
                                    <select [(ngModel)]="selectedAgent[order.orderID]" class="form-select form-select-sm mb-2">
                                        <option [ngValue]="null">Select Agent</option>
                                        <ng-container *ngIf="availableAgents.length > 0; else noAgents">
                                            <option *ngFor="let agent of availableAgents" [ngValue]="agent"> {{ agent.name }} ({{ agent.phone }}) </option>
                                        </ng-container>

                                        <ng-template #noAgents>
                                            <option [ngValue]="null" disabled>No agents available</option>
                                        </ng-template>
                                    </select>
                                    <button class="btn btn-sm btn-primary w-100" (click)="assignAgent(order.orderID)" [disabled]="!selectedAgent[order.orderID] || isAssigning[order.orderID]">
                                        <span *ngIf="isAssigning[order.orderID]" class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                                        <span>{{ isAssigning[order.orderID] ? 'Assigning...' : 'Assign Agent' }}</span>
                                    </button>
                                    <small *ngIf="agentError" class="text-danger d-block mt-2">{{ agentError }}</small>
                                </div>
                            </ng-container>

                            <ng-container *ngIf="activeTab !== 'placed'">
                                <div class="mt-3 p-3 border-top">
                                    <p class="mb-0">
                                        <strong class="fw-bold">Assigned Agent:</strong>
                                        <span class="text-primary fw-semibold">{{ order.agentName || 'â€”' }}</span>
                                    </p>
                                </div>
                            </ng-container>
                        </div>
                    </div>
                </div>
            </ng-container>

            <ng-template #noOrdersMessage>
                <div class="col-12">
                    <div class="d-flex justify-content-center w-100 my-5">
                        <div class="alert alert-info text-center px-4 py-3 shadow-sm w-50">
                            <h4 class="alert-heading">No Orders Here!</h4>
                            <p>There are no {{ activeTab | uppercase }} orders right now. Check back later!</p>
                        </div>
                    </div>
                </div>
            </ng-template>
        </div>
    </div>
</div>
<app-admin-footer></app-admin-footer>